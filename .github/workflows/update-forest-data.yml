name: Update Forest Data

on:
  # schedule:
    # Twice daily: 6 AM and 6 PM UTC (~4-5 PM / 4-5 AM AEST)
    # - cron: "0 6,18 * * *" # todo: enable after fixing
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-snapshot:
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.58.2-noble
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Restore geocoding cache
        uses: actions/cache@v4
        with:
          path: data/cache/coordinates.sqlite
          key: geocoding-cache-${{ runner.os }}-v2-${{ github.run_id }}
          restore-keys: |
            geocoding-cache-${{ runner.os }}-v2-
          save-always: true

      - name: Restore browser profile cache
        uses: actions/cache@v4
        with:
          path: data/cache/browser-profile
          key: browser-profile-${{ runner.os }}-v1-${{ github.run_id }}
          restore-keys: |
            browser-profile-${{ runner.os }}-v1-
          save-always: true

      - name: Generate snapshot
        run: xvfb-run --auto-servernum -- npx -y tsx scripts/generate-snapshot.ts
        env:
          PROXY_USERNAME: ${{ secrets.DECODO_PROXY_USERNAME }}
          PROXY_PASSWORD: ${{ secrets.DECODO_PROXY_PASSWORD }}
          GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}
          NOMINATIM_BASE_URL: https://nominatim.openstreetmap.org

      - name: Commit and push snapshot
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: "chore: update forest data snapshot [skip ci]"
          file_pattern: "apps/web/public/forests-snapshot.json apps/web/public/forests-snapshot.meta.json"

      - name: Upload snapshot artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: forest-snapshot
          path: |
            apps/web/public/forests-snapshot.json
            apps/web/public/forests-snapshot.meta.json
          retention-days: 7
          if-no-files-found: ignore
